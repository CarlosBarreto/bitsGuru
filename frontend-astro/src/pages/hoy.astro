---
import Layout from '../layouts/Layout.astro';
---

<Layout title="¿Cómo me irá hoy?">
	<main class="container">
		<div class="interaction-zone">
			<button id="ask-button">¿Cómo me irá hoy?</button>
		</div>

		<div id="cards-container" class="cards-container">
			<!-- Las cartas se cargarán aquí dinámicamente -->
		</div>

		<div id="guru-response-container" class="guru-response-container">
			<h2 class="response-title">Respuesta del Gurú:</h2>
			<p id="guru-response" class="guru-response"></p>
		</div>
	</main>
</Layout>

<style is:inline>
	.card {
		border: 2px solid var(--color-accent);
		background-color: #1c1c2e;
		color: var(--color-text);
		padding: 1.5rem 1rem;
		width: 180px;
		height: 250px;
		border-radius: 10px;
		text-align: center;
		display: flex;
        flex-direction: column;
		justify-content: flex-start;
		font-weight: bold;
		box-shadow: 0 0 15px rgba(90, 168, 151, 0.2);
        transition: transform 0.2s ease;
	}
    .card:hover {
        transform: translateY(-5px);
    }
    .card h4 {
        margin: 0 0 0.75rem 0;
        font-family: var(--font-heading);
        color: var(--color-heading);
        font-size: 1.1rem;
    }
    .card p {
        margin: 0;
        font-family: var(--font-body);
        font-size: 0.85rem;
        line-height: 1.5;
        color: #b0b0b0;
    }

	.interaction-zone {
		text-align: center;
		margin-bottom: 2rem;
	}
	#ask-button {
        background-color: var(--color-accent);
        color: #000;
		padding: 0.75rem 1.5rem;
		border-radius: 8px;
		border: none;
		font-weight: bold;
		cursor: pointer;
		transition: background-color 0.3s ease;
	}
	#ask-button:hover {
        background-color: var(--color-accent-hover);
	}
    #ask-button:disabled {
        background-color: #3a6d62;
        cursor: not-allowed;
    }
	.guru-response-container {
		background-color: rgba(28, 28, 46, 0.7);
		border: 1px solid var(--color-accent);
		border-radius: 8px;
		padding: 1.5rem;
		min-height: 100px;
        display: none; /* Oculto por defecto */
	}
	.response-title {
		color: var(--color-heading);
		margin-top: 0;
		margin-bottom: 1rem;
		font-size: 1.25rem;
	}
	.guru-response {
		color: #d1d1d1;
		line-height: 1.7;
        white-space: pre-wrap;
        opacity: 0;
        transition: opacity 1s ease-in-out;
	}
    .guru-response.visible {
        opacity: 1;
    }
</style>

<script>
	import { getTarotReading, askGuru } from '../utils/api.js';

	document.addEventListener('DOMContentLoaded', () => {
		const cardsContainer = document.getElementById('cards-container');
		const askButton = document.getElementById('ask-button') as HTMLButtonElement;
		const responseContainer = document.getElementById('guru-response-container');
		const guruResponseEl = document.getElementById('guru-response');

		let currentCards: { nombre: string, descripcion: string }[] = [];

		async function displayInitialCards() {
            cardsContainer.innerHTML = '<p>Barajando las cartas cósmicas...</p>';
			currentCards = await getTarotReading(2);
			cardsContainer.innerHTML = ''; // Limpiar
			
			currentCards.forEach(cardData => {
				const cardDiv = document.createElement('div');
				cardDiv.className = 'card';
				cardDiv.innerHTML = `<h4>${cardData.nombre}</h4><p>${cardData.descripcion}</p>`;
				cardsContainer.appendChild(cardDiv);
			});
		}

		askButton.addEventListener('click', async () => {
            // Mostrar estado de carga
            askButton.disabled = true;
            askButton.textContent = 'Consultando...';
            responseContainer.style.display = 'none';
            guruResponseEl.classList.remove('visible');
            
			await displayInitialCards();

            guruResponseEl.textContent = 'El Gurú está sintonizando con el cosmos...';
            responseContainer.style.display = 'block';
            guruResponseEl.classList.add('visible');


			const apiResponse = await askGuru("¿cómo me irá hoy?", currentCards);

            // Mostrar respuesta y prompt
			guruResponseEl.classList.remove('visible');
            
            setTimeout(() => {
                guruResponseEl.textContent = apiResponse.respuesta || apiResponse.error || "Respuesta no encontrada.";
                guruResponseEl.classList.add('visible');

                askButton.disabled = false;
                askButton.textContent = '¿Cómo me irá hoy?';
            }, 500); // Pequeño delay para la transición
		});
	});
</script>